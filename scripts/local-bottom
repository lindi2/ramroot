#!/bin/sh
case "$1" in
prereqs)
	echo ""
	exit 0
	;;
esac

echo "ramroot: local-bottom"
set -x
snapshot=""
rootuuid=""
for x in $(cat /proc/cmdline); do
    case $x in
	snapshot=*)
	    snapshot=${x#snapshot=}
	    ;;
	rootuuid=*)
	    rootuuid=${x#rootuuid=}
	    ;;
    esac
done

if [ "${snapshot}" = "" ]; then
    echo "no snapshot parameter given! dropping to shell"
    /bin/sh
    . /conf/param.conf
fi

if [ "${rootuuid}" = "" ]; then
    echo "no rootuuid parameter given! dropping to shell"
    /bin/sh
    . /conf/param.conf
fi

mkdir /fs
while ! mount -n /dev/disk/by-uuid/${rootuuid} /fs; do
    ls -l /dev/disk/by-uuid
    echo "== Waiting for ${rootuuid}"
    sleep 2
done

echo "snapshot=$snapshot"
cp -a /fs/snapshot/${snapshot}/* ${rootmnt}
umount /fs
rmdir /fs
