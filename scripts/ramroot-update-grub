#!/bin/sh
if [ "$ramroot" = "" ]; then
    echo "Use only with ramroot-admin"
    exit 1
fi

default="$1"
fallback="$2"
fallback_timeout="$3"

if [ ! -d "$ramroot/snapshot/${default}/boot" ]; then
    echo "Default snapshot does not exist"
    exit 1
fi

newlst=`mktemp`

echo "timeout 10" >> $newlst
echo "root (hd0,0)" >> $newlst
if [ "$fallback" != "" ]; then
    echo "default saved" >> $newlst
    echo "fallback $fallback" >> $newlst
else
    echo "default $default" >> $newlst
fi

if [ -e /etc/ramroot/boot-info ]; then
    . /etc/ramroot/boot-info
fi
for i in `cd $ramroot/snapshot && echo *`; do
    title="`cat $ramroot/snapshot/$i/etc/ramroot/grub-title`"
    echo "title $title" >> $newlst
    extraopts=" ramroot_uuid=$boot_uuid ramroot_snapshot=$i panic=60"
    if [ "$fallback" != "" -a "$i" = "$default" ]; then
	extraopts+=" ramroot_watchdog=$fallback_timeout"
    fi
    grep -E "^(kernel|initrd)" $ramroot/snapshot/$i/boot/grub/menu.lst\
    | head -n 2\
    | sed "s@^@ @;s@/boot/@/snapshot/$i/boot/@;s@ root=/dev/hda1 ro @ @"\
    | sed "/^ kernel/s@\$@$extraopts@"\
    >> $newlst
    if [ "$fallback" != "" -a "$i" = "$default" ]; then
	echo " savedefault fallback" >> $newlst
    fi
	
    echo >> $newlst
done

mount -o remount,rw $ramroot
mv $newlst $ramroot/boot/grub/menu.lst
if [ "$fallback" != "" ]; then
    grub-set-default --root-directory=$ramroot $default
fi
mount -o remount,ro $ramroot
