todo
----

use kpartx instead of losetup
fdisk: use c, u?
give visual indication that watchdog is running
tell user how he can deactivate watchdog
write --help for ramroot-*
provide ramroot-diff?
make sure no hardware watchdog is present or make them understand longer timeout
remount,rw for mount?
root on hda2
dhclient should try forever
handle multiple ethernets
*if rootfs is full, do not write empty menu.lst
*boot_uuid can have *?
mtdram total_size=300000
 allocation failed: out of vmalloc space - use vmalloc=<size> to increase size.
finnish keyboard layout
is there a way to make usb stick read-only under linux?
detect memory size, use jffs2 for < 180M, tmpfs for others

http://lwn.net/Articles/219827/

runtime: change default hostname to something more descriptive,
something that mentions ramroot?

doc: /etc/ramroot
doc: authorized_keys
doc: /etc/initramfs-tools
doc: /usr/local/bin

build: configuration file?
build: automate fetching sources for binaries on image
build: make size of flash image configurable
doc: document use of special uuid space
build: add more tests
serial console?

?: make it possible to access shell if cp takes a long time on bootup

doc:
ramroot-admin CMD
ramroot-snapshot PREV NUM DESC
ramroot-update-grub DEFAULT FALLBACK FALLBACK-TIMEOUT


failsafe scenarios
------------------

1) user does apt-get dist-upgrade that upgrades glibc
2) user is aware of potential trouble and tells ramroot "save state as
snapshot 8 and boot it. If I don't ssh within 10 minutes reboot
snapshot 7".

1) user starts to configure things
2) power outage hits
3) unsaved changes are lost but system boots from latest saved snapshot

1) user changes firewall settings
2) user notices he has locked himself out!

1) user makes a small change
2) user saves state as snapshot 8
3) user thinks the change is small and doesn't want to reboot
4) power outage hits 30 days later
5) systems reboots but snapshot 8 is not bootable!


1) upgrade glibc
2) ramroot-snapshot 7 8 'glibc upgrade'
3) ramroot-update-grub --default 8 --failsafe 7 --failsafe-timeout 10
4) reboot
5) ramroot-stop-watchdog
6) ramroot-update-grub --default 8


urls
----

http://www.iro.umontreal.ca/~monnier/gnu-linux/debian-live-usb
http://osdir.com/ml/handhelds.linux.intimate/2001-07/msg00005.html
http://jbakshi.50webs.com/Linux_tutorial/GRUB/grubmain.html
http://gentoo-wiki.com/HOWTO_Small_Footprint_Gentoo_on_USB




unionfs
-------

mount -t unionfs -o dirs=/branch_rw=rw:/branch_ro=ro unionfs /union


compFUSEd
---------

apt-get install libfuse2 liblzo2-2 fuse-utils ucf
dpkg -i compfused_0.1cvs200712321-1_i386.deb

# local-top
ramroot_fs=compfused >> /conf/param.conf

# premount
modprobe fuse
mkdir /tmpfs
mount none /tmpfs -t tmpfs
cp /etc/compfused.conf /.compFUSEd
compfused /root
echo FSTYPE=dummy > /conf/param.conf
echo ROOTFLAGS= >> /conf/param.conf
echo ROOT=none >> /conf/param.conf
echo readonly=n >> /conf/param.conf
#copy_exec /usr/bin/fusermount /sbin
mount -n -o move /compfused /root
mkdir /root/tmpfs
mount -n -o move /tmpfs /root/tmpfs

+if [ "$ramroot_fs" = "compfused" ]; then
+    modprobe fuse
+    mkdir /tmpfs
+    mount none /tmpfs -t tmpfs
+    cp /etc/compfused.conf /.compFUSEd
+    sed -i s@/usr/src/@/root/@ /.compFUSEd
+    sed -i s@/usr/cf_src@/tmpfs@ /.compFUSEd
+    compfused /root
+    echo FSTYPE=dummy > /conf/param.conf
+    echo ROOTFLAGS= >> /conf/param.conf
+    echo ROOT=none >> /conf/param.conf
+    echo readonly=n >> /conf/param.conf
+fi


fusecompress
------------

sudo mount -t tmpfs -o size=512M none /tmpfs
sudo fusecompress -o default_permissions,allow_other /tmpfs /fusecompress
sudo mount --bind /dev/ /fusecompress/dev
sudo debootstrap etch /fusecompress http://apt-proxy.kurp.hut.fi:9999/debian

$ sudo chroot /fusecompress
root@colosseum:/# apt-get update
Get:1 http://apt-proxy.kurp.hut.fi etch Release.gpg [378B]
Hit http://apt-proxy.kurp.hut.fi etch Release
Ign http://apt-proxy.kurp.hut.fi etch/main Packages/DiffIndex
Hit http://apt-proxy.kurp.hut.fi etch/main Packages
Fetched 378B in 0s (1586B/s)
Reading package lists... Error!
E: Couldn't make mmap of 12582912 bytes - mmap (19 No such device)
W: Unable to munmap
E: Problem closing the file - close (107 Transport endpoint is not connected)
E: The package lists or status file could not be parsed or opened.
E: Problem closing the file - close (107 Transport endpoint is not connected)


$ sudo ls /fusecompress
ls: /fusecompress: Transport endpoint is not connected


(gdb) bt
#0  0xb7d2a947 in raise () from /lib/tls/libc.so.6
#1  0xb7d2c0c9 in abort () from /lib/tls/libc.so.6
#2  0xb7f17994 in __gnu_cxx::__verbose_terminate_handler () from /usr/lib/libstdc++.so.6
#3  0xb7f153b5 in std::set_unexpected () from /usr/lib/libstdc++.so.6
#4  0xb7f153f2 in std::terminate () from /usr/lib/libstdc++.so.6
#5  0xb7f1552a in __cxa_throw () from /usr/lib/libstdc++.so.6
#6  0xb7f1596b in operator new () from /usr/lib/libstdc++.so.6
#7  0xb7f15a3d in operator new[] () from /usr/lib/libstdc++.so.6
#8  0x0804fd28 in MemoryMap::truncate (this=0x807924c, size=0) at MemoryMap.hpp:18
#9  0x0804c1c5 in Memory::truncate (this=0x8079210, name=0x8077af9 "var/cache/apt/pkgcache.bin", size=0) at Memory.cpp:61
#10 0x0804b138 in FuseCompress::truncate (name=<value optimized out>, size=0) at FuseCompress.cpp:391
#11 0xb7f932c4 in fuse_new () from /usr/lib/libfuse.so.2
#12 0xb7f97402 in fuse_reply_readlink () from /usr/lib/libfuse.so.2
#13 0xb7f987c6 in fuse_session_process () from /usr/lib/libfuse.so.2
#14 0xb7f959a9 in fuse_session_loop () from /usr/lib/libfuse.so.2
#15 0xb7f730bd in start_thread () from /lib/tls/libpthread.so.0
#16 0xb7dce01e in clone () from /lib/tls/libc.so.6

sudo umount /fusecompress/dev
sudo umount /fusecompress


hostname-not-set:~# du -shx /
77M     /
hostname-not-set:~# du -shx --apparent-size /
111M    /

55M with gzip for every file
46M with gzip for tar
111M uncompressed

how to do shutdown?
how to access tmpfs?


# ls -l /proc/840/cwd/etc/initramfs-tools /etc/initramfs-tools
/etc/initramfs-tools:
total 12
drwxr-xr-x  2 root root  60 Feb 24 20:54 conf.d
drwxr-xr-x  2 root root  60 Feb 26 18:58 hooks
-rw-r--r--  1 root root 801 Apr 13  2007 initramfs.conf
-rw-r--r--  1 root root 221 Feb 24 20:55 modules
drwxr-xr-x 11 root root 220 Feb 24 20:54 scripts
-rw-r--r--  1 root root 316 Apr  6  2007 update-initramfs.conf

/proc/840/cwd/etc/initramfs-tools:
total 12
drwxr-xr-x  2 root root  60 Feb 24 20:54 conf.d
drwxr-xr-x  2 root root  60 Feb 26 18:58 hooks
-rw-r--r--  1 root root 685 Apr 13  2007 initramfs.conf
-rw-r--r--  1 root root 288 Feb 24 20:55 modules
drwxr-xr-x 11 root root 220 Feb 24 20:54 scripts
-rw-r--r--  1 root root 294 Apr  6  2007 update-initramfs.conf


# ls -l {/proc/840/cwd,}/lib/libc-2.3.6.so
-rwxr-xr-x 1 root root 1147548 Jan 19 12:14 /lib/libc-2.3.6.so
-rwxr-xr-x 1 root root  711596 Jan 19 12:14 /proc/840/cwd/lib/libc-2.3.6.so
hostname-not-set:~# gzip < /lib/libc-2.3.6.so | wc -c
536747
hostname-not-set:~# gzip -1 < /lib/libc-2.3.6.so | wc -c
578828

with bz2 and 500k blocks:

# ls -l {/proc/843/cwd,}/lib/libc-2.3.6.so
-rwxr-xr-x 1 root root 1147548 Jan 19 12:14 /lib/libc-2.3.6.so
-rwxr-xr-x 1 root root  501983 Jan 19 12:14 /proc/843/cwd/lib/libc-2.3.6.so


hostname-not-set:~# du -shx /
61M     /

