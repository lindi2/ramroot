#!/bin/bash
set -e
set -x
export LC_ALL=C

if [ -e img ]; then rm -f img; fi
if [ -d mnt ]; then rmdir mnt; fi
mkdir mnt
# 512*1024*1024/(512*63*255) = 65
dd if=/dev/zero of=img bs=1M count=0 seek=512
set +e
/sbin/fdisk -C 65 -H 255 -S 63 img <<EOF
n
p
1
1
65
a
1
w
q
EOF
set -e

if [ ! -e /dev/loop0 ]; then
    sudo modprobe loop
fi
loopdev="`sudo losetup -f`"
sudo losetup -o 32256 "${loopdev}" img
# 64*255*63*512/4096 = 130520
sudo mkfs -t ext2 -b 4096 "${loopdev}" 130520
ramroot_uuid="`uuidgen`"
sudo tune2fs -U $ramroot_uuid "${loopdev}"
sudo losetup -d "${loopdev}"

sudo mkdir -p fs/snapshot/0/boot/grub
echo y | sudo chroot fs/snapshot/0 update-grub
sudo sed -i s@/boot@/snapshot/0/boot@ fs/snapshot/0/boot/grub/menu.lst
sudo sed -i "/^kernel/s@ro \$@ro ramroot_uuid=${ramroot_uuid} ramroot_snapshot=0 ramroot_fs=jffs2 ramroot_jffs2size=90000 @" fs/snapshot/0/boot/grub/menu.lst

sudo mount img mnt -oloop,offset=32256
sudo cp -a fs/snapshot mnt
sudo mkdir -p mnt/boot/grub
sudo cp /usr/lib/grub/i386-pc/{stage1,e2fs_stage1_5,stage2} mnt/boot/grub
sudo umount mnt

grub <<EOF
device (hd0) img
geometry (hd0) 65 255 63
root (hd0,0)
setup (hd0)
quit
EOF

sudo mount img mnt -oloop,offset=32256
echo -e "default 0\ntimeout 10\ntitle `cat mnt/snapshot/0/etc/ramroot/grub-title`\nconfigfile (hd0,0)/snapshot/0/boot/grub/menu.lst" | sudo tee mnt/boot/grub/menu.lst
sudo umount mnt
rmdir mnt
